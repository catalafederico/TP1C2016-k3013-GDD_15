/*CREO NUEVO ESQUEMA */
CREATE SCHEMA [GDD_15] AUTHORIZATION [gd];
GO
/*CREO LAS  19 TABLAS DEL DER.
LOS CAMPOS QUE EMPIEZAN CON N_ID SON IDS
N_ NUMEROS
C_ CODIGOS
D_ DESCRIPCIONES 
D_DESCRED DESCRIPCION 
D_DESCRIP DESCRIPCION CORTA
*/
/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_USUARIO_NOMBRE VARCHAR(250) UNIQUE,
	C_PASSWORD VARCHAR(250),
	N_CANT_INTENTOS TINYINT,
	N_PUBLICACION_GRATIS VARCHAR(2) DEFAULT 'SI',
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO SMALLINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100) UNIQUE,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT NOT NULL,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100) UNIQUE,
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRIP VARCHAR(50) UNIQUE,
	D_DESCRED VARCHAR(250) UNIQUE
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_RUBRO BIGINT,
	N_ID_DIRECCION BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	N_TELEFONO TINYINT,
	C_CORREO VARCHAR(50),
	F_CREACION DATETIME
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) NOT NULL,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	N_TELEFONO TINYINT,
	C_CORREO VARCHAR(50)	
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	N_ID_RUBRO BIGINT,
	N_ID_ESTADO BIGINT,
	N_ID_TIPO BIGINT,
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_PERMITE_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE ESTADOS */
CREATE TABLE GDD_15.ESTADOS (
	N_ID_ESTADO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ESTADO VARCHAR(50),
);
GO
/*CREO LA TABLA DE TIPOS */
CREATE TABLE GDD_15.TIPOS (
	N_ID_TIPO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO VARCHAR(50),
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT NOT NULL,
	C_TIPO_PAGO VARCHAR(50),
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	C_VISIBILIDAD BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_COMPRA BIGINT,
	N_MONTO FLOAT(24),
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	C_VISIBILIDAD BIGINT IDENTITY(10002,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50) UNIQUE,
	N_COMISION_PRECIO FLOAT(24),
	N_COMISION_PORCENTAJE FLOAT(24),
	N_COMISION_ENVIO FLOAT(24),
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_MONTO FLOAT(24),
	C_GANADOR TINYINT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT PRIMARY KEY ,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/* CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/* CREO LAS FOREIGN KEY */

alter table GDD_15.FACTURAS add constraint FK_FACTURA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_VISIBILIDAD
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS (N_ID_OFERTA);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS (N_ID_COMPRA);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS (N_ID_RUBRO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_ESTADO
	foreign key (N_ID_ESTADO) references GDD_15.ESTADOS (N_ID_ESTADO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_TIPO
	foreign key (N_ID_TIPO) references GDD_15.TIPOS (N_ID_TIPO);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS(N_ID_COMPRA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS(N_ID_OFERTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMPRESA_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLI_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLIENTE_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO

/*Inserto las funcionalidades*/

INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rol');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Usuarios');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rubro');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de visibilidad de publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Generar Publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Comprar/Ofertar');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Historial');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Calificar al Vendedor');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Consulta de facturas');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Listado Estadístico');
GO

/*Creo el rol Administrativo*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Administrativo');
GO


/*Se agregan funcionalidades al rol Administrativo*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Administrativo' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Rol', 'ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Listado Estadístico');
GO

/*Creo el rol Cliente*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Cliente');
GO

/*Se agregan funcionalidades al rol Cliente*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Cliente' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Comprar/Ofertar', 'Historial', 'Calificar al Vendedor', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Creo el rol Empresa*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Empresa');
GO

/*Se agregan funcionalidades al rol Empresa*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Empresa' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Consulta de facturas', 'Listado Estadístico');
GO

/* Se inserta el usuario admin, password w23e */

INSERT INTO GDD_15.USUARIOS(C_USUARIO_NOMBRE,C_PASSWORD)
VALUES ('admin',(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256','w23e')),3,250) ))
GO

/* Se le asignan todos los roles al usuario admin */

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT tablaUsuarios.N_ID_USUARIO, tablaRoles.N_ID_ROL FROM GDD_15.USUARIOS tablaUsuarios, GDD_15.ROLES tablaRoles
WHERE tablaUsuarios.C_USUARIO_NOMBRE = 'admin'
GO

/* Cargo las visibilidades */

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Platino', 180, 0.10, 20

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Oro', 140, 0.15, 30

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Plata', 100, 0.20, 40

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Bronze', 60, 0.30, 50

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Gratis', 0, 0, 0

/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_USUARIO_NOMBRE VARCHAR(250) UNIQUE,
	C_PASSWORD VARCHAR(250),
	N_CANT_INTENTOS TINYINT,
	N_PUBLICACION_GRATIS VARCHAR(2) DEFAULT 'SI',
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO SMALLINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100) UNIQUE,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT NOT NULL,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100) UNIQUE,
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRIP VARCHAR(50) UNIQUE,
	D_DESCRED VARCHAR(250) UNIQUE
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_RUBRO BIGINT,
	N_ID_DIRECCION BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	N_TELEFONO TINYINT,
	C_CORREO VARCHAR(50),
	F_CREACION DATETIME
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) NOT NULL,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	N_TELEFONO TINYINT,
	C_CORREO VARCHAR(50)	
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	N_ID_RUBRO BIGINT,
	N_ID_ESTADO BIGINT,
	N_ID_TIPO BIGINT,
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_PERMITE_ENVIO VARCHAR(2) DEFAULT 'NO'
);
GO
/*CREO LA TABLA DE ESTADOS */
CREATE TABLE GDD_15.ESTADOS (
	N_ID_ESTADO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ESTADO VARCHAR(50),
);
GO
/*CREO LA TABLA DE TIPOS */
CREATE TABLE GDD_15.TIPOS (
	N_ID_TIPO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO VARCHAR(50),
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT NOT NULL,
	C_TIPO_PAGO VARCHAR(50),
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	C_VISIBILIDAD BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_COMPRA BIGINT,
	N_MONTO FLOAT(24),
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	C_VISIBILIDAD BIGINT IDENTITY(10002,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50) UNIQUE,
	N_COMISION_PRECIO FLOAT(24),
	N_COMISION_PORCENTAJE FLOAT(24),
	N_COMISION_ENVIO FLOAT(24),
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_MONTO FLOAT(24),
	C_GANADOR TINYINT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	F_ALTA DATETIME,
	N_CANTIDAD INT,
	C_ENVIO VARCHAR(2)
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT PRIMARY KEY ,
	N_ID_COMPRA BIGINT,
	N_ID_OFERTA BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/* CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/* CREO LAS FOREIGN KEY */

alter table GDD_15.FACTURAS add constraint FK_FACTURA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_VISIBILIDAD
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS (N_ID_OFERTA);
GO
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS (N_ID_COMPRA);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (C_VISIBILIDAD) references GDD_15.VISIBILIDADES (C_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS (N_ID_RUBRO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_ESTADO
	foreign key (N_ID_ESTADO) references GDD_15.ESTADOS (N_ID_ESTADO);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_TIPO
	foreign key (N_ID_TIPO) references GDD_15.TIPOS (N_ID_TIPO);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_COMPRA
	foreign key (N_ID_COMPRA) references GDD_15.COMPRAS(N_ID_COMPRA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_OFERTA
	foreign key (N_ID_OFERTA) references GDD_15.OFERTAS(N_ID_OFERTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO
/*
alter table GDD_15.EMPRESAS add constraint FK_EMPRESA_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLI_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO
alter table GDD_15.CLIENTES add constraint FK_CLIENTE_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS(N_ID_USUARIO);
GO*/


--CREO TABLA TEMPORAL QUE ME AYUDA AL MOMENTO DE LA MIGRACION DE CLIENTES Y EMPRESAS--
CREATE TABLE GDD_15.#tmp_usuarios
( 
	n_id_usuario bigint identity(1,1),
	N_ID_DIRECCION BIGINT,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100) ,
	D_APELLIDOS VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	F_NACIMIENTO DATETIME,
	C_CORREO VARCHAR(50),
	N_TELEFONO TINYINT,
	N_ID_RUBRO BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT VARCHAR(50),
	D_NOMBRE_CONTACTO VARCHAR(100),
	F_CREACION DATETIME

);
GO
-- CREO TRIGGER QUE ME INSERTA F_ALTA EN USUARIOS AL INSERTAR UN USUARIO NUEVO--
CREATE TRIGGER F_ALTA ON gdd_15.USUARIOS 
for insert as
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON
declare @n_id_usuario bigint

update GDD_15.USUARIOS
set f_alta=GETDATE()
select N_ID_USUARIO from inserted

SET IDENTITY_INSERT gdd_15.USUARIOS  OFF
end
GO
--CREO TRIGGER EN CLIENTES QUE ME INSERTA EL CLIENTE EN LA TABLA USUARIOS--
create TRIGGER  alta_USUARIO ON gdd_15.CLIENTES 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_DOCUMENTO,N_DOCUMENTO
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO
--CREO TRIGGER EN EMPRESAS QUE ME INSERTA LA EMPRESA EN LA TABLA USUARIOS--
create TRIGGER  alta_USU_EMP  ON gdd_15.EMPRESAS 
	 after insert AS
begin
SET IDENTITY_INSERT gdd_15.USUARIOS  ON

	insert into  GDD_15.USUARIOS
	(n_id_usuario,c_usuario_nombre , C_PASSWORD )
	select N_ID_USUARIO, N_CUIT,N_CUIT
	from inserted
	
	SET IDENTITY_INSERT gdd_15.USUARIOS  off
end;
GO

CREATE PROCEDURE GDD_15.MIGRO_DIRECCIONES AS 
BEGIN
	/* INSERTO DIRECCIONES DE LOS CLIENTES */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	select DISTINCT Cli_Dom_Calle,
					Cli_Nro_Calle,
					Cli_Depto,
					Cli_Piso,
					Cli_Cod_Postal
	FROM gd_esquema.Maestra
	WHERE Cli_Dni IS NOT NULL;

	/* INSERTO DIRECCIONES DE LOS EMPRESAS */
	INSERT INTO GDD_15.DIRECCIONES 
	(
		C_CALLE,
		N_NUMERO,
		C_DEPTO,
		C_PISO,
		C_POSTAL
	)
	SELECT DISTINCT Publ_Empresa_Dom_Calle,
					Publ_Empresa_Nro_Calle,
					Publ_Empresa_Piso,
					Publ_Empresa_Depto,
					Publ_Empresa_Cod_Postal
	FROM gd_esquema.Maestra 
	WHERE Publ_Empresa_Cuit IS NOT NULL;
END;
GO

-- PRC QUE MIGRA CLIENTES Y EMPRESAS ---
CREATE PROCEDURE GDD_15.MIGRO_USUARIOS AS
BEGIN
	/*  INSERTO CLIENTES  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(	
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION, 
		C_CORREO
	)
	SELECT DISTINCT m.Cli_Dni,
					'DNI',					
					m.Cli_Apeliido,
					m.Cli_Nombre,
					CONVERT(CHAR(10),Cli_Fecha_Nac,103)fecha_nac,
					d.N_ID_DIRECCION, 
					M.Cli_Mail
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE m.Cli_Dni IS NOT NULL
	and d.n_numero=m.Cli_Nro_Calle
	and d.c_piso=convert(varchar(50),m.Cli_Piso)
	and d.C_DEPTO=convert(varchar(50),m.Cli_Depto)
	and d.C_CALLE=m.Cli_Dom_Calle;
	
	/*INSERTO EMPRESAS  en la tmp_usuarios*/
	INSERT INTO #tmp_usuarios
	(
		
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
	SELECT DISTINCT m.Publ_Empresa_Cuit,
					CONVERT(CHAR(10),Publ_Empresa_Fecha_Creacion,103)fecha_CREAC,
					m.Publ_Empresa_Mail,
					m.Publ_Empresa_Razon_Social,
					d.N_ID_DIRECCION
	FROM gd_esquema.Maestra m, gdd_15.DIRECCIONES d
	WHERE Publ_Empresa_Cuit IS NOT NULL
	and d.n_numero=m.Publ_Empresa_Nro_Calle
	and d.C_CALLE=m.Publ_Empresa_Dom_Calle;
	--and d.c_piso=convert(varchar(50),m.Publ_Empresa_Piso)
	--and d.C_DEPTO=convert(varchar(50),m.Publ_Empresa_Depto);

/*INSERTO CLIENTES */
	INSERT INTO GDD_15.CLIENTES
	(	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO
	)
select	N_ID_USUARIO,
		N_DOCUMENTO,
		C_TIPO_DOCUMENTO,
		D_APELLIDOS,
		D_NOMBRES,
		F_NACIMIENTO,
		N_ID_DIRECCION,
		C_CORREO 
		from #tmp_usuarios
where N_DOCUMENTO is not null;
	
/*INSERTO EMPRESAS*/
	INSERT INTO GDD_15.EMPRESAS
	(
		N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
	)
SELECT N_ID_USUARIO,
		N_CUIT,
		F_CREACION,
		C_CORREO,
		C_RAZON_SOCIAL,
		N_ID_DIRECCION
		FROM #tmp_usuarios
		WHERE N_CUIT IS NOT NULL;
END;
GO

--INICIO MIGRACION --
EXEC GDD_15.MIGRO_DIRECCIONES;
EXEC GDD_15.MIGRO_USUARIOS;
-- FIN MIGRACION --

/*Inserto las funcionalidades*/

INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rol');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Usuarios');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rubro');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de visibilidad de publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Generar Publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Comprar/Ofertar');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Historial');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Calificar al Vendedor');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Consulta de facturas');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Listado Estadístico');
GO

/*Creo el rol Administrativo*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Administrativo');
GO


/*Se agregan funcionalidades al rol Administrativo*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Administrativo' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Rol', 'ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Listado Estadístico');
GO

/*Creo el rol Cliente*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Cliente');
GO

/*Se agregan funcionalidades al rol Cliente*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Cliente' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Comprar/Ofertar', 'Historial', 'Calificar al Vendedor', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Creo el rol Empresa*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Empresa');
GO

/*Se agregan funcionalidades al rol Empresa*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Empresa' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'Generar Publicación', 'Consulta de facturas', 'Listado Estadístico');
GO

/* Se inserta el usuario admin, password w23e */

INSERT INTO GDD_15.USUARIOS(C_USUARIO_NOMBRE,C_PASSWORD)
VALUES ('admin',(SELECT SUBSTRING(master.dbo.fn_varbintohexstr(HASHBYTES('SHA2_256','w23e')),3,250) ))
GO

/* Se le asignan todos los roles al usuario admin */

INSERT INTO GDD_15.ROLES_USUARIOS(N_ID_USUARIO, N_ID_ROL)
SELECT tablaUsuarios.N_ID_USUARIO, tablaRoles.N_ID_ROL FROM GDD_15.USUARIOS tablaUsuarios, GDD_15.ROLES tablaRoles
WHERE tablaUsuarios.C_USUARIO_NOMBRE = 'admin'
GO

/* Cargo las visibilidades */

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Platino', 180, 0.10, 20

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Oro', 140, 0.15, 30

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Plata', 100, 0.20, 40

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Bronze', 60, 0.30, 50

INSERT INTO GDD_15.VISIBILIDADES(D_DESCRIP,N_COMISION_PRECIO,N_COMISION_PORCENTAJE,N_COMISION_ENVIO)
SELECT 'Gratis', 0, 0, 0


--Inserto los tipos de Publicacion--
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Subasta');
INSERT INTO GDD_15.TIPOS(C_TIPO) VALUES ('Compra Inmediata');

--Inserto los estados de una Publicacion--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Publicada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Borrador');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Activa');--- tengo la duda si activa es lo mismo que publicada ?--
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Pausada');
INSERT INTO GDD_15.ESTADOS(C_ESTADO) VALUES ('Finalizada');
