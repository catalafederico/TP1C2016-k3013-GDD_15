/*CREO NUEVO ESQUEMA */
CREATE SCHEMA [GDD_15] AUTHORIZATION [gd];
GO
/*CREO LAS  19 TABLAS DEL DER.
LOS CAMPOS QUE EMPIEZAN CON N_ID SON IDS
N_ NUMEROS
C_ CODIGOS
D_ DESCRIPCIONES 
D_DESCRED DESCRIPCION 
D_DESCRIP DESCRIPCION CORTA
*/
/*CREO LA TABLA DE USUARIOS */
CREATE TABLE GDD_15.USUARIOS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_DIRECCION BIGINT,
	N_ID_ROL BIGINT,
	C_USUARIO_WEB VARCHAR(250),
	C_PASSWORD VARCHAR(250),
	C_CORREO VARCHAR(50),
	N_TELEFONO TINYINT,
	N_CANT_INTENTOS TINYINT,
	N_HABILITADO TINYINT DEFAULT 1,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE DIRECCIONES */
CREATE TABLE GDD_15.DIRECCIONES (
	N_ID_DIRECCION BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_CALLE VARCHAR(100),
	N_NUMERO SMALLINT,
	C_PISO VARCHAR(50),
	C_DEPTO VARCHAR(50),
	C_POSTAL VARCHAR(50)
);
GO
/*CREO LA TABLA DE ROLES */
CREATE TABLE GDD_15.ROLES (
	N_ID_ROL BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_ROL VARCHAR(100),
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE ROLES POR USUARIO */
CREATE TABLE GDD_15.ROLES_USUARIOS (
	N_ID_USUARIO BIGINT NOT NULL,
	N_ID_ROL BIGINT  NOT NULL,
	F_ALTA DATETIME,
	F_BAJA DATETIME
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES */
CREATE TABLE GDD_15.FUNCIONALIDADES (
	N_ID_FUNCIONALIDAD BIGINT IDENTITY(1,1) PRIMARY KEY,
	D_DESCRED VARCHAR(100),
);
GO
/*CREO LA TABLA DE FUNCIONALIDADES POR ROLES */
CREATE TABLE GDD_15.FUNCIONALIDADES_ROLES (
	N_ID_ROL BIGINT NOT NULL,
	N_ID_FUNCIONALIDAD BIGINT NOT NULL,
);
GO
/*CREO LA TABLA DE RUBROS */
CREATE TABLE GDD_15.RUBROS (
	N_ID_RUBRO BIGINT IDENTITY(1,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50),
	D_DESCRED VARCHAR(250)
);
GO
/*CREO LA TABLA DE EMPRESAS */
CREATE TABLE GDD_15.EMPRESAS (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_RUBRO BIGINT,
	C_RAZON_SOCIAL VARCHAR(100),
	C_CIUDAD VARCHAR(100),
	N_CUIT TINYINT,
	D_NOMBRES_CONTACTO VARCHAR(100)
);
GO
/*CREO LA TABLA DE CLIENTES */
CREATE TABLE GDD_15.CLIENTES (
	N_ID_USUARIO BIGINT IDENTITY(1,1) PRIMARY KEY,
	C_TIPO_DOCUMENTO  VARCHAR(100),
	N_DOCUMENTO VARCHAR(100),
	D_NOMBRES VARCHAR(100),
	D_APELLIDOS VARCHAR(100),
	F_NACIMIENTO DATETIME,
	F_ALTA DATETIME,
	F_ACTUALIZAC DATETIME
);
GO
/*CREO LA TABLA DE PUBLICACIONES */
CREATE TABLE GDD_15.PUBLICACIONES (
	N_ID_PUBLICACION BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_VISIBILIDAD BIGINT,
	N_ID_USUARIO BIGINT,
	C_TIPO_PUBLICACION VARCHAR(50),
	D_DESCRED VARCHAR(100),
	N_STOCK INT,
	F_INICIO DATETIME,
	F_VENCIMIENTO DATETIME,
	N_PRECIO FLOAT(24),
	C_ESTADO VARCHAR(50),
	C_PERMITE_PREG VARCHAR(2),/*EN EL DER QUE MANDAMOS ESTA PUESTO TINYINT */
	N_COSTO FLOAT(24)
);
GO
/*CREO LA TABLA DE PUBLICACIONES POR RUBRO  */
CREATE TABLE GDD_15.PUBLICACIONES_RUBROS (
	N_ID_PUBLICACION BIGINT NOT NULL,
	N_ID_RUBRO BIGINT NOT NULL
);
GO
/*CREO LA TABLA DE FACTURAS */
CREATE TABLE GDD_15.FACTURAS (
	N_ID_FACTURA BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_TOTAL FLOAT(24),
	C_TIPO_PAGO VARCHAR(50),
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE LOS ITEMS DE LAS FACTURAS */
CREATE TABLE GDD_15.FACTURAS_ITEMS (
	N_ID_ITEM BIGINT IDENTITY(1,1) PRIMARY KEY,
	N_ID_FACTURA BIGINT NOT NULL,
	N_ID_PUBLICACION BIGINT NOT NULL,
	N_MONTO FLOAT(24),
	N_CANTIDAD INT
);
GO
/*CREO LA TABLA DE VISIBILIDADES */
CREATE TABLE GDD_15.VISIBILIDADES (
	N_ID_VISIBILIDAD BIGINT IDENTITY(1,1) PRIMARY KEY ,
	D_DESCRIP VARCHAR(50),
	N_PRECIO FLOAT(24),
	N_COMISION  FLOAT(24)
);
GO
/*CREO LA TABLA DE OFERTAS */
CREATE TABLE GDD_15.OFERTAS (
	N_ID_OFERTA BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	N_MONTO FLOAT(24),
	C_GANADOR  TINYINT,
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE COMPRAS */
CREATE TABLE GDD_15.COMPRAS (
	N_ID_COMPRA BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	N_CANTIDAD INT,
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE PREGUNTAS */
CREATE TABLE GDD_15.PREGUNTAS (
	N_ID_PREGUNTA BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	D_DESCRED VARCHAR(250),
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE RESPUESTAS */
CREATE TABLE GDD_15.RESPUESTAS (
	N_ID_RESPUESTA BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_PREGUNTA BIGINT,
	D_DESCRED VARCHAR(250),
	F_ALTA DATETIME
);
GO
/*CREO LA TABLA DE CALIFICACIONES */
CREATE TABLE GDD_15.CALIFICACIONES (
	N_ID_CALIFICACION BIGINT IDENTITY(1,1) PRIMARY KEY ,
	N_ID_PUBLICACION BIGINT,
	N_ID_CLIENTE BIGINT,
	C_CALIFICACION SMALLINT,
	D_DESCRIP VARCHAR(250)
);
GO

/*CREO  LAS PRIMARY KEY COMPUESTAS  */
alter table GDD_15.PUBLICACIONES_RUBROS add constraint PK_PUBL_POR_RUBRO
	primary key clustered (N_ID_PUBLICACION,N_ID_RUBRO);
GO
alter table GDD_15.ROLES_USUARIOS add constraint PK_ROL_POR_USUARIO
	primary key clustered (N_ID_ROL,N_ID_USUARIO);
GO
alter table GDD_15.FUNCIONALIDADES_ROLES add constraint PK_FUNC_POR_ROL
	primary key clustered (N_ID_ROL,N_ID_FUNCIONALIDAD);
GO

/*CREO LAS FOREIGN KEY   */
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM
	foreign key (N_ID_FACTURA) references GDD_15.FACTURAS (N_ID_FACTURA);
GO	
alter table GDD_15.FACTURAS_ITEMS add constraint FK_FACTURA_ITEM_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO	
alter table GDD_15.OFERTAS add constraint FK_OFERTA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.OFERTAS add constraint FK_OFERTA_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRAS_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES (N_ID_USUARIO);
GO
alter table GDD_15.COMPRAS add constraint FK_COMPRA_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES (N_ID_PUBLICACION);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_VISIB
	foreign key (N_ID_VISIBILIDAD) references GDD_15.VISIBILIDADES (N_ID_VISIBILIDAD);
GO
alter table GDD_15.PUBLICACIONES add constraint FK_PUBL_USUARIO
	foreign key (N_ID_USUARIO) references GDD_15.USUARIOS (N_ID_USUARIO);
GO
alter table GDD_15.PREGUNTAS add constraint FK_PREG_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES(N_ID_PUBLICACION);
GO
alter table GDD_15.PREGUNTAS add constraint FK_PREG_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.RESPUESTAS add constraint FK_RESP_PREG
	foreign key (N_ID_PREGUNTA) references GDD_15.PREGUNTAS(N_ID_PREGUNTA);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_PUBL
	foreign key (N_ID_PUBLICACION) references GDD_15.PUBLICACIONES(N_ID_PUBLICACION);
GO
alter table GDD_15.CALIFICACIONES add constraint FK_CALIF_CLIENTE
	foreign key (N_ID_CLIENTE) references GDD_15.CLIENTES(N_ID_USUARIO);
GO
alter table GDD_15.EMPRESAS add constraint FK_EMP_RUBRO
	foreign key (N_ID_RUBRO) references GDD_15.RUBROS(N_ID_RUBRO);
GO
alter table GDD_15.USUARIOS add constraint FK_USUARIO_DIR
	foreign key (N_ID_DIRECCION) references GDD_15.DIRECCIONES(N_ID_DIRECCION);
GO

/*Inserto las funcionalidades*/

INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rol');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Usuarios');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de Rubro');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('ABM de visibilidad de publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Generar Publicación');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Comprar/Ofertar');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Historial');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Calificar al Vendedor');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Consulta de facturas');
INSERT INTO GDD_15.FUNCIONALIDADES (D_DESCRED) VALUES ('Listado Estadístico');
GO

/*Creo el rol Administrativo*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Administrativo');
GO




/*Se agregan funcionalidades al rol Administrativo*/



INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Administrativo';
GO

/*Creo el rol Cliente*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Cliente');
GO


/*Se agregan funcionalidades al rol Cliente*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Cliente' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Generar Publicación', 'Comprar/Ofertar', 'Historial', 'Calificar al Vendedor', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Creo el rol Empresa*/

INSERT INTO GDD_15.ROLES(C_ROL) VALUES('Empresa');
GO

/*Se agregan funcionalidades al rol Empresa*/

INSERT INTO GDD_15.FUNCIONALIDADES_ROLES(N_ID_ROL, N_ID_FUNCIONALIDAD)
SELECT tablaRol.N_ID_ROL,tablaFuncionalidad.N_ID_FUNCIONALIDAD FROM GDD_15.ROLES  tablaRol, GDD_15.FUNCIONALIDADES tablaFuncionalidad
WHERE tablaRol.C_ROL = 'Empresa' AND tablaFuncionalidad.D_DESCRED IN ('ABM de Usuarios', 'ABM de Rubro', 'ABM de visibilidad de publicación', 'Generar Publicación', 'Consulta de facturas', 'Listado Estadístico');
GO

/*Tests

SELECT * FROM GDD_15.FUNCIONALIDADES
SELECT * FROM GDD_15.FUNCIONALIDADES_ROLES
SELECT * FROM GDD_15.ROLES

*/